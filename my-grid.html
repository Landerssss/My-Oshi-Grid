<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ¨æ ¼å­ v3.0 (æ‹–æ‹½+ç¼©æ”¾ç‰ˆ)</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { box-sizing: border-box; user-select: none; }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #121212;
            color: #ffffff;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { margin-bottom: 20px; color: #ff8fab; }

        .controls {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            border: 1px solid #444;
        }

        select, button, input[type="text"] {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #555;
            background: #333;
            color: white;
            font-size: 14px;
        }

        button {
            background-color: #ff8fab;
            color: #000;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
        button:hover { background-color: #ffb6c1; }

        .tips {
            font-size: 12px;
            color: #888;
            margin-bottom: 10px;
        }

        #capture-area {
            background-color: #121212;
            padding: 30px;
            border: 1px solid #333;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: fit-content;
            margin: 0 auto;
        }

        .grid-title {
            background: transparent;
            border: none;
            color: white;
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
            outline: none;
        }

        .grid-container {
            display: grid;
            gap: 10px;
        }

        .grid-item {
            background-color: #1e1e1e;
            border: 2px dashed #444;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: border-color 0.2s;
        }

        /* æ‹–æ‹½è¿›å…¥æ—¶çš„æ ·å¼ */
        .grid-item.drag-over {
            border-color: #fff;
            background-color: #333;
        }

        /* ç¼–è¾‘æ¨¡å¼ï¼ˆç¼©æ”¾æ¨¡å¼ï¼‰ */
        .grid-item.editing {
            border: 2px solid #ff4757; /* çº¢è‰²è¾¹æ¡†æç¤ºæ­£åœ¨ç¼–è¾‘ */
            cursor: move; /* æç¤ºå¯ä»¥ç§»åŠ¨å›¾ç‰‡ */
        }

        .img-area {
            flex: 1;
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden; /* å¿…é¡»éšè—æº¢å‡ºï¼Œå¦åˆ™ç¼©æ”¾ä¼šç›–ä½åˆ«çš„æ ¼å­ */
            cursor: pointer;
        }

        .img-area img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: center center;
            pointer-events: none; /* é»˜è®¤ä¸å“åº”é¼ æ ‡ï¼Œç”±çˆ¶çº§å“åº” */
        }

        /* ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œå›¾ç‰‡éœ€è¦å“åº”é¼ æ ‡æ‰èƒ½è¢«æ‹–åŠ¨ä½ç½® */
        .grid-item.editing .img-area img {
            /* object-fit: cover;  åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹æˆ‘ä»¬å¯èƒ½éœ€è¦ç§»é™¤è¿™ä¸ªå±æ€§å®Œå…¨é transformæ§åˆ¶ï¼Œæˆ–è€…ä¿ç•™å®ƒä½œä¸ºåŸºå‡† */
        }

        .upload-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            color: #555;
            pointer-events: none;
        }

        .item-input {
            width: 100%;
            background: rgba(0,0,0,0.8);
            border: none;
            color: #fff;
            text-align: center;
            font-size: 12px;
            padding: 6px 2px;
            outline: none;
            z-index: 10;
            cursor: text;
        }

        .watermark {
            margin-top: 15px;
            color: #444;
            font-size: 12px;
            align-self: flex-end;
        }

        #hidden-file-input { display: none; }

    </style>
</head>
<body>

    <h1>âœ¨ æˆ‘çš„æ¨æ ¼å­ v3.0</h1>
    <div class="tips">ğŸ’¡ æç¤ºï¼šæŒ‰ä½å›¾ç‰‡å¯æ‹–æ‹½äº¤æ¢ä½ç½® | <b>åŒå‡»å›¾ç‰‡</b>å¼€å¯ç¼©æ”¾/å¹³ç§»æ¨¡å¼</div>

    <div class="controls">
        <select id="layout-select">
            <option value="3x3">ä¹å®«æ ¼ (3x3)</option>
            <option value="4x3">å¤§æ»¡è´¯ (4x3)</option>
            <option value="5x3">å®½å± (5x3)</option>
            <option value="2x2">å››å®«æ ¼ (2x2)</option>
        </select>
        <input type="text" id="main-title-input" value="æˆ‘çš„å¹´åº¦åŠ¨ç”»åˆ—è¡¨">
        <button onclick="downloadImage()">â¬‡ï¸ ä¿å­˜å›¾ç‰‡</button>
    </div>

    <div id="capture-area">
        <input type="text" class="grid-title" id="display-title" value="æˆ‘çš„å¹´åº¦åŠ¨ç”»åˆ—è¡¨">
        <div class="grid-container" id="grid-box"></div>
        <div class="watermark">github.com/ywh555hhh/anime-role-grid</div>
    </div>

    <input type="file" id="hidden-file-input" accept="image/*">

    <script>
        const layouts = {
            '3x3': { cols: 3, rows: 3, width: 110, height: 150 },
            '4x3': { cols: 4, rows: 3, width: 100, height: 140 },
            '5x3': { cols: 5, rows: 3, width: 90,  height: 130 },
            '2x2': { cols: 2, rows: 2, width: 180, height: 240 }
        };

        const gridBox = document.getElementById('grid-box');
        const layoutSelect = document.getElementById('layout-select');
        const fileInput = document.getElementById('hidden-file-input');
        const titleInput = document.getElementById('main-title-input');
        const displayTitle = document.getElementById('display-title');
        
        let currentUploadTarget = null;
        let dragSourceIndex = null;
        
        // ç¼–è¾‘æ¨¡å¼å˜é‡
        let editingItem = null;
        let isDraggingImage = false;
        let startX, startY, initialTranslateX, initialTranslateY;

        window.onload = function() { render('3x3'); };

        layoutSelect.addEventListener('change', (e) => render(e.target.value));
        titleInput.addEventListener('input', (e) => displayTitle.value = e.target.value);

        function render(type) {
            const config = layouts[type];
            gridBox.innerHTML = '';
            gridBox.style.gridTemplateColumns = `repeat(${config.cols}, ${config.width}px)`;

            const total = config.cols * config.rows;

            for(let i=0; i<total; i++) {
                const item = document.createElement('div');
                item.className = 'grid-item';
                item.style.height = config.height + 'px';
                item.dataset.index = i; // å­˜å‚¨ç´¢å¼•ç”¨äºäº¤æ¢

                // åˆå§‹åŒ– Transform æ•°æ®
                item.dataset.scale = 1;
                item.dataset.x = 0;
                item.dataset.y = 0;

                // --- 1. æ‹–æ‹½äº¤æ¢é€»è¾‘ (Drag & Drop) ---
                item.draggable = true; // å…è®¸æ‹–æ‹½æ•´ä¸ªæ ¼å­

                item.addEventListener('dragstart', function(e) {
                    if (editingItem) return e.preventDefault(); // ç¼–è¾‘æ¨¡å¼ä¸‹ç¦æ­¢äº¤æ¢
                    dragSourceIndex = this.dataset.index;
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragover', function(e) {
                    e.preventDefault(); // å…è®¸æ”¾ç½®
                    this.classList.add('drag-over');
                });

                item.addEventListener('dragleave', function(e) {
                    this.classList.remove('drag-over');
                });

                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    const sourceIndex = dragSourceIndex;
                    const targetIndex = this.dataset.index;
                    
                    if (sourceIndex !== targetIndex) {
                        swapImages(sourceIndex, targetIndex);
                    }
                });

                // --- 2. å†…éƒ¨ç»“æ„ä¸ç‚¹å‡»ä¸Šä¼  ---
                item.innerHTML = `
                    <div class="img-area">
                        <span class="upload-icon">+</span>
                        <img src="" alt="img">
                    </div>
                    <input type="text" class="item-input" placeholder="ç‚¹å‡»è¾“å…¥" onclick="event.stopPropagation()">
                `;

                // ç‚¹å‡»ä¸Šä¼  (ä»…åœ¨éç¼–è¾‘æ¨¡å¼ä¸‹)
                const imgArea = item.querySelector('.img-area');
                imgArea.onclick = function(e) {
                    if (item.classList.contains('editing')) return; // ç¼–è¾‘æ¨¡å¼ä¸‹ç‚¹å‡»æ— æ•ˆï¼ˆé˜²æ­¢å†²çªï¼‰
                    
                    const img = this.querySelector('img');
                    // å¦‚æœå·²ç»æœ‰å›¾ï¼Œç‚¹å‡»ä¸è§¦å‘ä¸Šä¼ ï¼Œé™¤éæ˜¯ç©ºçš„
                    if (img.style.display !== 'block') {
                         triggerUpload(img, item);
                    }
                };

                // --- 3. åŒå‡»è¿›å…¥ç¼–è¾‘æ¨¡å¼ (Zoom/Pan) ---
                imgArea.addEventListener('dblclick', function(e) {
                    e.stopPropagation(); // é˜²æ­¢å†’æ³¡
                    const img = this.querySelector('img');
                    if (img.style.display !== 'block') {
                        triggerUpload(img, item); // æ²¡å›¾æ—¶åŒå‡»ä¹Ÿæ˜¯ä¸Šä¼ 
                        return;
                    }
                    toggleEditMode(item);
                });

                gridBox.appendChild(item);
            }
        }

        // è§¦å‘ä¸Šä¼ 
        function triggerUpload(imgElement, itemElement) {
            currentUploadTarget = { img: imgElement, item: itemElement };
            fileInput.value = '';
            fileInput.click();
        }

        fileInput.addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0] && currentUploadTarget) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    const img = currentUploadTarget.img;
                    const item = currentUploadTarget.item;
                    
                    img.src = evt.target.result;
                    img.style.display = 'block';
                    item.querySelector('.upload-icon').style.display = 'none';
                    
                    // é‡ç½®å˜æ¢
                    resetTransform(item);
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        // äº¤æ¢å›¾ç‰‡å‡½æ•°
        function swapImages(idx1, idx2) {
            const items = document.querySelectorAll('.grid-item');
            const item1 = items[idx1];
            const item2 = items[idx2];
            const img1 = item1.querySelector('img');
            const img2 = item2.querySelector('img');
            const icon1 = item1.querySelector('.upload-icon');
            const icon2 = item2.querySelector('.upload-icon');

            // äº¤æ¢ Src
            const tempSrc = img1.src;
            img1.src = img2.src;
            img2.src = tempSrc;

            // äº¤æ¢æ˜¾ç¤ºçŠ¶æ€
            const tempDisplay = img1.style.display;
            img1.style.display = img2.style.display;
            img2.style.display = tempDisplay;

            // äº¤æ¢å›¾æ ‡æ˜¾ç¤º
            const tempIcon = icon1.style.display;
            icon1.style.display = icon2.style.display;
            icon2.style.display = tempIcon;

            // äº¤æ¢å˜æ¢æ•°æ® (ç¼©æ”¾/ä½ç½®) - è®©ä½ è¾›è‹¦è°ƒå¥½çš„ä½ç½®ä¹Ÿè·Ÿç€èµ°
            const scale1 = item1.dataset.scale; const x1 = item1.dataset.x; const y1 = item1.dataset.y;
            const scale2 = item2.dataset.scale; const x2 = item2.dataset.x; const y2 = item2.dataset.y;

            updateTransform(item1, scale2, x2, y2);
            updateTransform(item2, scale1, x1, y1);
        }

        // --- ç¼–è¾‘æ¨¡å¼æ ¸å¿ƒé€»è¾‘ ---

        function toggleEditMode(item) {
            // å¦‚æœå·²ç»åœ¨ç¼–è¾‘åˆ«çš„ï¼Œå…ˆé€€å‡ºé‚£ä¸ª
            if (editingItem && editingItem !== item) {
                exitEditMode();
            }

            if (item.classList.contains('editing')) {
                exitEditMode();
            } else {
                enterEditMode(item);
            }
        }

        function enterEditMode(item) {
            editingItem = item;
            item.classList.add('editing');
            item.draggable = false; // ç¼–è¾‘æ—¶ç¦æ­¢æ‹–æ‹½æ ¼å­äº¤æ¢
            
            // ç»‘å®šæ»šè½®ç¼©æ”¾
            item.onwheel = function(e) {
                e.preventDefault();
                let scale = parseFloat(item.dataset.scale);
                if (e.deltaY < 0) scale += 0.1;
                else scale -= 0.1;
                if (scale < 0.5) scale = 0.5; // æœ€å°ç¼©æ”¾
                if (scale > 5) scale = 5;     // æœ€å¤§ç¼©æ”¾
                
                updateTransform(item, scale, item.dataset.x, item.dataset.y);
            };

            // ç»‘å®šé¼ æ ‡æ‹–æ‹½å¹³ç§»
            item.onmousedown = function(e) {
                if (e.target.tagName === 'INPUT') return; // ä¸å½±å“è¾“å…¥æ¡†
                isDraggingImage = true;
                startX = e.clientX;
                startY = e.clientY;
                initialTranslateX = parseFloat(item.dataset.x);
                initialTranslateY = parseFloat(item.dataset.y);
                item.style.cursor = 'grabbing';
            };
        }

        function exitEditMode() {
            if (editingItem) {
                editingItem.classList.remove('editing');
                editingItem.draggable = true; // æ¢å¤äº¤æ¢åŠŸèƒ½
                editingItem.onwheel = null;
                editingItem.onmousedown = null;
                editingItem.style.cursor = 'pointer';
                editingItem = null;
            }
        }

        // å…¨å±€ç›‘å¬é¼ æ ‡ç§»åŠ¨å’Œæ¾å¼€ï¼ˆç”¨äºå¹³ç§»å›¾ç‰‡ï¼‰
        window.addEventListener('mousemove', function(e) {
            if (!isDraggingImage || !editingItem) return;
            e.preventDefault();
            
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            
            // è€ƒè™‘ç¼©æ”¾å¯¹ç§»åŠ¨é€Ÿåº¦çš„å½±å“ï¼Œç¨å¾®é™¤ä»¥ scale è®©ç§»åŠ¨æ›´è‡ªç„¶
            const currentScale = parseFloat(editingItem.dataset.scale);
            
            const newX = initialTranslateX + dx;
            const newY = initialTranslateY + dy;
            
            updateTransform(editingItem, currentScale, newX, newY);
        });

        window.addEventListener('mouseup', function() {
            isDraggingImage = false;
            if (editingItem) editingItem.style.cursor = 'move';
        });

        // ç‚¹å‡»ç”»å¸ƒç©ºç™½å¤„é€€å‡ºç¼–è¾‘
        document.body.addEventListener('click', function(e) {
            if (editingItem && !editingItem.contains(e.target)) {
                exitEditMode();
            }
        });

        function updateTransform(item, scale, x, y) {
            item.dataset.scale = scale;
            item.dataset.x = x;
            item.dataset.y = y;
            const img = item.querySelector('img');
            img.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
        }

        function resetTransform(item) {
            updateTransform(item, 1, 0, 0);
        }

        // å¯¼å‡ºå›¾ç‰‡
        function downloadImage() {
            // å¯¼å‡ºå‰å…ˆé€€å‡ºç¼–è¾‘æ¨¡å¼ï¼Œå»æ‰çº¢è‰²è¾¹æ¡†
            exitEditMode();
            
            const node = document.getElementById('capture-area');
            html2canvas(node, {
                backgroundColor: "#121212",
                scale: 2,
                useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'æˆ‘çš„æ¨æ ¼å­.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }
    </script>
</body>
</html>
